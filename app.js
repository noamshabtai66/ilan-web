const blessings = [
  {
    title: "×œ××™×œ×Ÿ",
    from: "××•×¨×” ××©×ª×š",
    photo: "assets/people/ora.jpg",
    text: `××™×š ×©×¢×•×‘×¨×•×ª ×”×©× ×™×
×•××ª×” ×‘×Ÿ 54 ×•× ×¨××” ×›×ž×• ×‘×Ÿ 30
×¦×¢×™×¨ ×‘×¨×•×—×š ×§×œ ×¨×’×œ×™×
×—×ª×™×š ××™×˜×œ×§×™ ×©×§×•×¦×¨ ×ž×—×ž××•×ª ×‘×›×œ ×ž×§×•×
×•×ž×‘×˜ ×˜×•×‘ ×‘×¢× ×™×™×
××‘× × ×¤×œ×
×’×‘×¨ ×ž×ª×—×©×‘
×‘×©×œ×Ÿ × ×”×“×¨
×•×”×›×™ ×—×©×•×‘ ×˜×•×‘ ×œ×‘ â¤ï¸
×–×›×™×ª×™ ×‘×‘×¢×œ ×ž×“×”×™×
×©×¨×§ ×”×•×œ×š ×•×ž×©×ª×‘×— ×¢× ×”×©× ×™×
×ž×•×›×™×— ×œ×›×•×œ× ×›×ž×” ××ª×” ×¢× ×¨×¦×•×Ÿ ×¢×–
××¤×™×œ×• ××ª ×”×¡×™×’×¨×™×•×ª ×”× ×—×ª ×‘×¦×“
××– ×œ×š ×××—×œ ×©× ×™× ××¨×•×›×•×ª ×•×™×¤×•×ª
×©×ž×—×•×ª ×•×‘×¨×™××•×ª
×¤×¨× ×¡×” ×œ×¨×•×‘
× ×›×“×™× × ×›×“×•×ª ×•×©×¢×¨×•×ª ×œ×‘× ×•×ª ×ž×©×ž×—×”
×•×”×¨×‘×” ×”×¨×‘×” ×‘×¨×›×” ×›×ž×•×‘×Ÿ ×™×—×“ ××™×ª×™
××•×”×‘×ª
××•×¨×” ××™×©×ª×šâ¤ï¸`
  },
  {
    title: "×œ××‘×•×©",
    from: "×”×“×¨×™",
    photo: "assets/people/hadar.jpg",
    text: `×œ××‘×•×© ×”×›×™ ×˜×•×‘ ×‘×¢×•×œ×
×©×ª×ž×™×“ ×¤×” ×‘×©×‘×™×œ×™
×©×œ×•×§×— ××•×ª×™ ×©×ž×—×–×™×¨
×©×™×© ×œ×• ×ª××•×›×œ ×”×›×™ ×”×›×™ ×˜×¢×™×
×©×ª×ž×™×“ ×“×•××’ ×œ×™ ×•×ž×¤× ×§ ××•×ª×™
×”×™× ×” ×™×© ×œ×š ×™×•× ×”×•×œ×“×ª 54
×œ×ž×¨×•×ª ×©×”×™×™×ª×™ × ×•×ª× ×ª ×œ×š ×’×’ 40
×–×• ×”×™×–×“×ž× ×•×ª ×˜×•×‘×” ×œ×”×“×•×ª ×¢×œ ×”×›×•×œ
×•×œ×”×’×™×“ ×©×× ×™ ×ž××•×“ ×ž××•×“ ×ž×¢×¨×™×›×”
×›×•×œ ×ž×” ×©××ª ×¢×•×©×” ×‘×™×©×‘×œ×™
×•××ª×” ×¢×•×©×” ×”×ž×•×Ÿ ×”×ž×•×Ÿ
×× ×™ ×ž××—×œ×ª ×œ×š ××•×©×¨ ×‘×¨×™××•×ª ×•×”×¦×œ×—×”
×©×ª×ž×©×™×š ×œ×™×§×¨×•×¢ ××ª ×›×•×œ× ×‘×˜× ×™×¡
×‘×§×™×¦×•×¨ ×× ×™ ××•×”×‘×ª ××•×ª×š ×”×ž×•×Ÿ ×”×ž×•×Ÿ
×•×ž××—×œ×ª ×œ×š ××ª ×›×•×œ ×”×˜×•×‘ ×©×‘×¢×•×œ×
×ž×”×“×¨×™ðŸ©·ðŸ©·`
  },
  {
    title: "×œ××‘×",
    from: "××‘×™×‘",
    photo: "assets/people/aviv.jpg",
    text: `×‘×¨×›×” ×œ××‘× ×œ×™×•× ×”×•×œ×“×ª 54

×œ××‘×, ×”×ž×•×Ÿ ×ž×–×œ ×˜×•×‘ ×œ×¨×’×œ ×™×•× ×”×•×œ×“×ª×š ×”-54!

×›×ž×• ×‘×›×œ ×©× ×”, ×× ×™ ×ž× ×¦×œ ××ª ×”×”×–×“×ž× ×•×ª ×”×–×• ×›×“×™ ×œ×•×ž×¨ ×œ×š ×›×ž×” ×× ×™ ×ž×¢×¨×™×š ××•×ª×š. ×× ×™ ×¨×•××” ××ª ×›×œ ×”×”×©×§×¢×” ×•×”×“××’×” ×©×œ×š ×œ×›×š ×©×œ× ×™×—×¡×¨ ×œ× ×• ×“×‘×¨, ×•×©×ª×ž×™×“ ×™×”×™×” ×œ× ×• ×”×›×™ × ×•×— ×©××¤×©×¨.

×× ×™ ×¨×•××” ×•×ž×¨×’×™×© ×›×ž×” ××ª×” ×¢×•×–×¨ ×•×“×•××’ ×œ×™ ×•×œ×¢×ª×™×“ ×©×œ×™; ×•×œ×ž×¨×•×ª ×©×–×” ×™×›×•×œ ×œ×¤×¢×ž×™× ×œ×”×™×•×ª ×§×¦×ª ×œ×•×—×¥, ×× ×™ ×™×•×“×¢ ×©×–×” ×ž×’×™×¢ ×ž×”×ž×§×•× ×”×›×™ ××›×¤×ª×™ ×©×™×©, ×•×–×” ×ž×•×›×™×— ××™×–×” ××‘× ×˜×•×‘ ××ª×” ×•×›×ž×” ××ª×” ×¨×•×¦×” ×©×× ×™ ××¦×œ×™×— ×•×©×™×”×™×” ×œ×™ ×˜×•×‘.

×× ×™ ×ž××—×œ ×œ×š ×”×ž×•×Ÿ ××•×©×¨, ×›×•×©×¨ ×•×‘×¨×™××•×ª, ×•×¢×•×“ ×”×¨×‘×” ×©× ×™× ×˜×•×‘×•×ª ×¢× ××•×ª×” ×¨×•×— ×¦×¢×™×¨×”. ×©×ª×–×›×” ×œ×”×¨×‘×” ×”×¦×œ×—×•×ª ×•×œ×¨×•×•×ª × ×—×ª ×ž×›×œ ×”×ž×©×¤×—×”, ×•×”×›×™ ×—×©×•×‘  ×©×ª×–×›×” ×œ×—×™×•×ª ×‘×¨×•×’×¢ ×•×‘×›×™×£, ×›×™ ×‘××ž×ª ×›×‘×¨ ×”×’×™×¢ ×”×’×™×œ ×œ×”×ª×—×™×œ ×œ×”× ×•×ª ×ž×›×œ ×ž×” ×©×‘× ×™×ª.

×‘××”×‘×” ×’×“×•×œ×”, ××‘×™×‘`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "×“×•×œ×‘",
    photo: "assets/people/dolev.jpg",
    text: `×™×© ×× ×©×™× ×©×”×’×™×œ ×©×œ×”× ×”×•× ×¨×§ ×ž×¡×¤×¨ ×•××ª×” ×”×”×•×›×—×” ×”×›×™ ×˜×•×‘×” ×œ×–×”.
×‘×Ÿ 54 ×¢× ×× ×¨×’×™×•×ª ×—×™×•×‘×™×•×ª ×•×¨×•×— ×¦×¢×™×¨×”.
×ž××—×œ×ª ×œ×š ×œ×”×ž×©×™×š ×œ×”× ×•×ª ×ž×”×—×™×™×, ×œ×”×’×©×™× ×ž×˜×¨×•×ª, ×œ×¦×‘×•×¨ ×—×•×•×™×•×ª ×•×œ×”×ª×ž×œ× ×‘×¡×™×¤×•×§ ×•×©×ž×—×”.
×©×ª×ž×©×™×š ×œ×¦×¢×•×“ ×œ×¦×™×“×” ×©×œ ××•×¨×”, ×©×•×ª×¤×ª×š ×œ×—×™×™× ×•×œ×“×¨×š, ×‘×©×•×ª×¤×•×ª ××ž×™×ª×™×ª, ×‘×¢×©×™×™×” ×ž×©×•×ª×¤×ª, ×‘×ª×ž×™×›×” ×”×“×“×™×ª ×•×‘×”×¨×‘×” ×¨×’×¢×™× ×©×œ ××•×©×¨ ×™×—×“.
×ª×•×“×” ×¢×œ ×”× ×ª×™× ×” ×”××™× ×¡×•×¤×™×ª, ×¢×œ ×”×—×¨×™×¦×•×ª ×•×”×ž×¡×™×¨×•×ª, ×¢×œ ×›×š ×©××ª×” ×ª×ž×™×“ ×¢×•×©×” ×”×›×œ ×‘××”×‘×” ×•×‘×—×™×•×š ×•××£ ×¤×¢× ×œ× × ×•×ª×Ÿ ×ª×—×•×©×” ×©×§×©×” ××• ×©××™×Ÿ ×›×—.
×•×›×ž×•×‘×Ÿ, ××™ ××¤×©×¨ ×©×œ× ×œ×”×–×›×™×¨ ××ª ×”××•×›×œ ×”× ×”×“×¨ ×•×”×§×¦×™×¦×•×ª ×“×’×™× ×”×˜×¢×™×ž×•×ª ×©×”×¤×›×• ×œ×“×™×‘×•×¨ ×”×—× ×‘×©×•×œ×—×Ÿ.
×ž××—×œ×ª ×œ×š ×‘×¨×™××•×ª ××™×ª× ×”, ×”×¦×œ×—×” ×‘×›×œ ×ª×—×•×, ×©×œ×•×•×”, ×©×ž×—×” ×•×”×ž×•×Ÿ ×©× ×™× ×˜×•×‘×•×ª ×•×ž×‘×•×¨×›×•×ª.
×ž×–×œ ×˜×•×‘ ×•×”×¨×‘×” ××•×©×¨,
×“×•×œ×‘.`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "× ×•×¢×",
    photo: "assets/people/noam.jpg",
    text: `×—×’ ×”××™×œ× ×•×ª ×”×’×™×¢ ×•×œ× ×• ×”×•× ×¨×§ ×ž×¡×ž×œ ×“×‘×¨ ××—×“, ×©×™×•× ×”×•×œ×“×ª×š ×›××Ÿ.
×¢×“×™×™×Ÿ ××•×ª×™ ××™×œ×Ÿ ×¦×¢×™×¨ ×©×œ× ×§×©×” ×œ×• ×©×•× ×“×‘×¨.
×ž×•×§×“× ×‘×‘×•×§×¨ ×”×•× ×›×‘×¨ ×§× ×œ×‘×©×œ ×•×œ×ª×§×ª×§ ×•××—×¨×™ ×–×” ×™×©×¨ ×œ×’×œ×¨×™×” ×‘×¦×¢×“×™ ×¢× ×§.
×”×›×œ ×¢×•×©×” ×ž×”×œ×‘ ×•×”× ×©×ž×” ×•×ª×ž×™×“ ×›××Ÿ ×œ×ª×ª ×¢×–×¨×”.
×ž××—×œ ×œ×š ×©× ×” ×©×œ ×‘×¨×™××•×ª, ××•×©×¨, ×¦×—×•×§, ××”×‘×”, ×¢×•×©×¨, ×‘×¨×›×” ×•×¡×™×¤×•×§.
××ž×Ÿ ×•×”×—×œ×•×ž×•×ª ×©×œ×š ×™×ª×’×©×ž×• ×‘×ž×œ×•××.
×× ×™ ×ž××—×œ ×œ×š ×©×ª×ž×©×™×š ×œ×”× ×•×ª ×•×œ×˜×™×™×œ ×‘×¢×•×œ×, ×œ×”×™×•×ª ×‘×¢×œ × ××ž×Ÿ ×•××‘× ×ž×•×©×œ×, ××™×© ×¢×¡×§×™× ×œ× ×§×˜×Ÿ.
×× ×™ ×›××Ÿ ×‘×©×‘×™×œ×š ×œ×›×œ ×‘×¢×™×” ×˜×›× ×•×œ×•×’×™×ª ×›×ž×•×‘×Ÿ,
×•×œ× ×©×›×—×ª×™ ××ª ×”×˜× ×™×¡ ×‘×©×‘×ª×•×ª ×‘×‘×•×§×¨, ××‘×œ ×‘×•× × ×•×“×”, ××•×œ×™ ×™×•× ××—×“ ×¢×•×“ ×ª×¢×§×•×£ ××•×ª×™.. ××• ×œ×¤×—×•×ª ×ª× ×¡×”.
×ž×–×œ ×˜×•×‘ ×¢× ×§,
× ×•×¢×.`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "×ž×¢×™×™×Ÿ",
    photo: "assets/people/mayaan.jpg",
    text: `×”× ×” ×”×’×™×¢×” ×¢×•×“ ×©× ×”
×©×‘×” ×× ×—× ×• ×—×•×’×’×™× ×œ×š
×•×–×” ×”×–×ž×Ÿ ×œ×”×•×“×•×ª ×•×œ×”×’×™×“ ×ª×•×“×”,
×¢×œ ×”×“×’×™× ×•×¢×œ ×”×§×¦×™×¦×•×ª ×‘×¨×•×˜×‘ ×œ×™×ž×•×Ÿ,
×¢×œ ×–×” ×©××ª×” ×—×•×©×‘ ×©××ª×” ×ž×œ×š ×”×˜× ×™×¡,
×¢×œ ×”×¤×™× ×•×§×™× ×œ×©×‘×ª ×©××ª×” ×•××ž× ×ž×›×™× ×™× ×œ× ×•.
×× ×™ ×ž××—×œ×ª ×œ×š ×œ×”×™×•×ª ×‘×¨×™× ×‘×œ×™ ×¦×•×•××¨ ×ª×¤×•×¡,
×ž×œ× × ×™×¦×—×•× ×•×ª ×‘×˜× ×™×¡,
×œ×”×ž×©×™×š ×œ×˜×™×™×œ ×‘×¢×•×œ× ×•×œ×”×’×™×“ ×©××ª×” ××™×˜×œ×§×™,
×œ×”× ×•×ª ×ž×”×™×œ×“×™×,
×œ×”× ×•×ª ×ž×”×§× ×™×•×ª ×‘×©×•×§ ×¢× ×”×§×•×¨×§×™× ×˜ ×”×—×“×© ×©×œ×š.
×•×”×›×™ ×—×©×•×‘ â€“ ×ª×ž×©×™×š ×œ×”×™×•×ª ×‘×“×™×•×§ ×›×›×”, ×¦×¢×™×¨ ×‘× ×¤×© ×•×¢× ×”×× ×¨×’×™×•×ª.
×ž××—×œ×ª ×œ×š ×©× ×” ×ž×œ××” ×‘×˜×™×•×œ×™×, ×•× ×™×¦×—×•× ×•×ª (×‘×˜× ×™×¡ ).`
  }
];

let currentIndex = 0;

const titleEl = document.querySelector("[data-title]");
const signatureEl = document.querySelector("[data-signature]");
const signatureNameEl = document.querySelector("[data-signature-name]");
const signaturePhotoEl = document.querySelector("[data-signature-photo]");
const progressEl = document.getElementById("blessing-progress");
const linesEl = document.getElementById("blessing-lines");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const celebrateBtn = document.getElementById("celebrate");
const confettiLayer = document.querySelector(".confetti");
const card = document.getElementById("card");
const musicToggle = document.getElementById("music-toggle");
const musicNext = document.getElementById("music-next");
const bgMusic = document.getElementById("bg-music");
const musicLabel = document.getElementById("music-label");

const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

let isMusicPlaying = false;
let audioContext = null;
let synthTimer = null;
let useSynth = false;
let touchStartX = null;
let currentTrack = 0;
const tracks = [
  {
    name: "Sunny Afternoon",
    url: "https://cdn.pixabay.com/download/audio/2023/03/25/audio_c3aa6a5b4b.mp3?filename=sunny-day-14569.mp3"
  },
  {
    name: "Light Steps",
    url: "https://cdn.pixabay.com/download/audio/2023/04/04/audio_234d61636d.mp3?filename=happy-background-113996.mp3"
  },
  {
    name: "Acoustic Smile",
    url: "https://cdn.pixabay.com/download/audio/2023/04/04/audio_31de4131a9.mp3?filename=acoustic-guitar-113983.mp3"
  }
];

function renderBlessing(index) {
  const blessing = blessings[index];
  titleEl.textContent = blessing.title;
  signatureNameEl.textContent = blessing.from;
  if (blessing.photo) {
    signaturePhotoEl.src = blessing.photo;
    signaturePhotoEl.alt = `×ª×ž×•× ×” ×©×œ ${blessing.from}`;
    signatureEl.classList.remove("no-photo");
  } else {
    signaturePhotoEl.removeAttribute("src");
    signaturePhotoEl.alt = "";
    signatureEl.classList.add("no-photo");
  }
  progressEl.textContent = `×‘×¨×›×” ${index + 1} ×ž×ª×•×š ${blessings.length}`;

  linesEl.innerHTML = "";
  const rawLines = blessing.text.split("\n");
  let visibleIndex = 0;

  rawLines.forEach((line) => {
    const trimmed = line.trim();
    const span = document.createElement("span");
    span.className = "line";
    span.style.setProperty("--i", visibleIndex);
    if (trimmed.length === 0) {
      span.classList.add("spacer");
      span.textContent = "\u00A0";
    } else {
      span.textContent = trimmed;
    }
    linesEl.appendChild(span);
    visibleIndex += 1;
  });

  prevBtn.disabled = blessings.length === 1 || index === 0;
  nextBtn.disabled = blessings.length === 1 || index === blessings.length - 1;
}

function createConfetti() {
  const colors = ["#e75480", "#f5a453", "#ff8fb4", "#5fc3bd"];
  for (let i = 0; i < 18; i += 1) {
    const piece = document.createElement("span");
    piece.textContent = "â¤";
    piece.style.color = colors[Math.floor(Math.random() * colors.length)];
    piece.style.setProperty("--x", `${(Math.random() - 0.5) * 160}px`);
    piece.style.setProperty("--drift", `${(Math.random() - 0.5) * 120}px`);
    piece.style.setProperty("--r", `${(Math.random() - 0.5) * 90}deg`);
    piece.style.setProperty("--s", `${0.7 + Math.random() * 0.8}`);
    piece.style.setProperty("--d", `${0.8 + Math.random() * 0.9}s`);
    confettiLayer.appendChild(piece);

    setTimeout(() => {
      piece.remove();
    }, 1400);
  }
}

function celebrate() {
  if (prefersReducedMotion) {
    card.classList.add("celebrate");
    setTimeout(() => card.classList.remove("celebrate"), 450);
    return;
  }
  createConfetti();
}

function ensureAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function setTrack(index) {
  if (!bgMusic) return;
  currentTrack = ((index % tracks.length) + tracks.length) % tracks.length;
  const track = tracks[currentTrack];
  bgMusic.src = track.url;
  if (musicLabel) {
    musicLabel.textContent = `×ž× ×’×Ÿ: ${track.name}`;
  }
}

function playSynthLoop() {
  if (synthTimer) {
    return;
  }
  ensureAudioContext();
  if (audioContext.state === "suspended") {
    audioContext.resume();
  }
  const tempo = 118;
  const beat = 60 / tempo;
  const pattern = [
    [261.63, 329.63, 392.0],
    [293.66, 369.99, 440.0],
    [246.94, 311.13, 392.0],
    [220.0, 277.18, 329.63]
  ];
  let step = 0;

  const playChord = (frequencies, startTime) => {
    frequencies.forEach((freq) => {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.0001, startTime);
      gain.gain.exponentialRampToValueAtTime(0.12, startTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, startTime + beat * 0.9);
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.start(startTime);
      osc.stop(startTime + beat);
    });
  };

  synthTimer = setInterval(() => {
    const now = audioContext.currentTime;
    playChord(pattern[step % pattern.length], now);
    step += 1;
  }, beat * 1000);
}

function stopSynthLoop() {
  if (synthTimer) {
    clearInterval(synthTimer);
    synthTimer = null;
  }
}

async function toggleMusic() {
  if (isMusicPlaying) {
    isMusicPlaying = false;
    musicToggle.textContent = "× ×’×Ÿ ×ž×•×–×™×§×”";
    musicToggle.classList.remove("is-playing");
    musicToggle.setAttribute("aria-pressed", "false");
    if (useSynth) {
      stopSynthLoop();
    } else if (bgMusic) {
      bgMusic.pause();
    }
    return;
  }

  isMusicPlaying = true;
  musicToggle.textContent = "×›×‘×” ×ž×•×–×™×§×”";
  musicToggle.classList.add("is-playing");
  musicToggle.setAttribute("aria-pressed", "true");

  if (bgMusic && !useSynth) {
    try {
      if (!bgMusic.src) {
        setTrack(currentTrack);
      }
      await bgMusic.play();
      return;
    } catch (err) {
      useSynth = true;
    }
  }
  playSynthLoop();
}

if (bgMusic) {
  bgMusic.addEventListener("error", () => {
    useSynth = true;
  });
}

prevBtn.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex -= 1;
    renderBlessing(currentIndex);
  }
});

nextBtn.addEventListener("click", () => {
  if (currentIndex < blessings.length - 1) {
    currentIndex += 1;
    renderBlessing(currentIndex);
  }
});

celebrateBtn.addEventListener("click", celebrate);
musicToggle.addEventListener("click", toggleMusic);
musicNext.addEventListener("click", () => {
  setTrack(currentTrack + 1);
  if (isMusicPlaying && bgMusic && !useSynth) {
    bgMusic
      .play()
      .catch(() => {
        useSynth = true;
        playSynthLoop();
      });
  }
});

card.addEventListener("touchstart", (event) => {
  if (!event.touches || event.touches.length === 0) {
    return;
  }
  touchStartX = event.touches[0].clientX;
});

card.addEventListener("touchend", (event) => {
  if (touchStartX === null) {
    return;
  }
  const endX = event.changedTouches[0].clientX;
  const delta = endX - touchStartX;
  touchStartX = null;
  if (Math.abs(delta) < 50) {
    return;
  }
  if (delta > 0) {
    prevBtn.click();
  } else {
    nextBtn.click();
  }
});

setTrack(0);
renderBlessing(currentIndex);
