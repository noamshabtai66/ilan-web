const blessings = [
  {
    title: "×œ××™×œ×Ÿ",
    from: "××•×¨×” ××©×ª×š",
    photo: "assets/people/ora.jpg",
    text: `××™×š ×©×¢×•×‘×¨×•×ª ×”×©× ×™×\n×•××ª×” ×‘×Ÿ 54 ×•× ×¨××” ×›×ž×• ×‘×Ÿ 30\n×¦×¢×™×¨ ×‘×¨×•×—×š ×§×œ ×¨×’×œ×™×\n×—×ª×™×š ××™×˜×œ×§×™ ×©×§×•×¦×¨ ×ž×—×ž××•×ª ×‘×›×œ ×ž×§×•×\n×•×ž×‘×˜ ×˜×•×‘ ×‘×¢× ×™×™×\n××‘× × ×¤×œ×\n×’×‘×¨ ×ž×ª×—×©×‘\n×‘×©×œ×Ÿ × ×”×“×¨\n×•×”×›×™ ×—×©×•×‘ ×˜×•×‘ ×œ×‘ â¤ï¸\n×–×›×™×ª×™ ×‘×‘×¢×œ ×ž×“×”×™×\n×©×¨×§ ×”×•×œ×š ×•×ž×©×ª×‘×— ×¢× ×”×©× ×™×\n×ž×•×›×™×— ×œ×›×•×œ× ×›×ž×” ××ª×” ×¢× ×¨×¦×•×Ÿ ×¢×–\n××¤×™×œ×• ××ª ×”×¡×™×’×¨×™×•×ª ×”× ×—×ª ×‘×¦×“\n××– ×œ×š ×××—×œ ×©× ×™× ××¨×•×›×•×ª ×•×™×¤×•×ª\n×©×ž×—×•×ª ×•×‘×¨×™××•×ª\n×¤×¨× ×¡×” ×œ×¨×•×‘\n× ×›×“×™× × ×›×“×•×ª ×•×©×¢×¨×•×ª ×œ×‘× ×•×ª ×ž×©×ž×—×”\n×•×”×¨×‘×” ×”×¨×‘×” ×‘×¨×›×” ×›×ž×•×‘×Ÿ ×™×—×“ ××™×ª×™\n××•×”×‘×ª\n××•×¨×” ××™×©×ª×šâ¤ï¸`
  },
  {
    title: "×œ××‘×•×©",
    from: "×”×“×¨×™",
    photo: "assets/people/hadar.jpg",
    text: `×œ××‘×•×© ×”×›×™ ×˜×•×‘ ×‘×¢×•×œ×\n×©×ª×ž×™×“ ×¤×” ×‘×©×‘×™×œ×™\n×©×œ×•×§×— ××•×ª×™ ×©×ž×—×–×™×¨\n×©×™×© ×œ×• ×ª××•×›×œ ×”×›×™ ×”×›×™ ×˜×¢×™×\n×©×ª×ž×™×“ ×“×•××’ ×œ×™ ×•×ž×¤× ×§ ××•×ª×™\n×”×™× ×” ×™×© ×œ×š ×™×•× ×”×•×œ×“×ª 54\n×œ×ž×¨×•×ª ×©×”×™×™×ª×™ × ×•×ª× ×ª ×œ×š ×’×’ 40\n×–×• ×”×™×–×“×ž× ×•×ª ×˜×•×‘×” ×œ×”×“×•×ª ×¢×œ ×”×›×•×œ\n×•×œ×”×’×™×“ ×©×× ×™ ×ž××•×“ ×ž××•×“ ×ž×¢×¨×™×›×”\n×›×•×œ ×ž×” ×©××ª ×¢×•×©×” ×‘×™×©×‘×œ×™\n×•××ª×” ×¢×•×©×” ×”×ž×•×Ÿ ×”×ž×•×Ÿ\n×× ×™ ×ž××—×œ×ª ×œ×š ××•×©×¨ ×‘×¨×™××•×ª ×•×”×¦×œ×—×”\n×©×ª×ž×©×™×š ×œ×™×§×¨×•×¢ ××ª ×›×•×œ× ×‘×˜× ×™×¡\n×‘×§×™×¦×•×¨ ×× ×™ ××•×”×‘×ª ××•×ª×š ×”×ž×•×Ÿ ×”×ž×•×Ÿ\n×ž××—×œ×ª ×œ×š ××ª ×›×•×œ ×”×˜×•×‘ ×©×‘×¢×•×œ×\n×ž×”×“×¨×™ðŸ©·ðŸ©·`
  },
  {
    title: "×œ××‘×",
    from: "××‘×™×‘",
    photo: "assets/people/aviv.jpg",
    text: `×œ××‘×, ×”×ž×•×Ÿ ×ž×–×œ ×˜×•×‘ ×œ×¨×’×œ ×™×•× ×”×•×œ×“×ª×š ×”-54!\n\n×›×ž×• ×‘×›×œ ×©× ×”, ×× ×™ ×ž× ×¦×œ ××ª ×”×”×–×“×ž× ×•×ª ×”×–×• ×›×“×™ ×œ×•×ž×¨ ×œ×š ×›×ž×” ×× ×™ ×ž×¢×¨×™×š ××•×ª×š. ×× ×™ ×¨×•××” ××ª ×›×œ ×”×”×©×§×¢×” ×•×”×“××’×” ×©×œ×š ×œ×›×š ×©×œ× ×™×—×¡×¨ ×œ× ×• ×“×‘×¨, ×•×©×ª×ž×™×“ ×™×”×™×” ×œ× ×• ×”×›×™ × ×•×— ×©××¤×©×¨.\n\n×× ×™ ×¨×•××” ×•×ž×¨×’×™×© ×›×ž×” ××ª×” ×¢×•×–×¨ ×•×“×•××’ ×œ×™ ×•×œ×¢×ª×™×“ ×©×œ×™; ×•×œ×ž×¨×•×ª ×©×–×” ×™×›×•×œ ×œ×¤×¢×ž×™× ×œ×”×™×•×ª ×§×¦×ª ×œ×•×—×¥, ×× ×™ ×™×•×“×¢ ×©×–×” ×ž×’×™×¢ ×ž×”×ž×§×•× ×”×›×™ ××›×¤×ª×™ ×©×™×©, ×•×–×” ×ž×•×›×™×— ××™×–×” ××‘× ×˜×•×‘ ××ª×” ×•×›×ž×” ××ª×” ×¨×•×¦×” ×©×× ×™ ××¦×œ×™×— ×•×©×™×”×™×” ×œ×™ ×˜×•×‘.\n\n×× ×™ ×ž××—×œ ×œ×š ×”×ž×•×Ÿ ××•×©×¨, ×›×•×©×¨ ×•×‘×¨×™××•×ª, ×•×¢×•×“ ×”×¨×‘×” ×©× ×™× ×˜×•×‘×•×ª ×¢× ××•×ª×” ×¨×•×— ×¦×¢×™×¨×”. ×©×ª×–×›×” ×œ×”×¨×‘×” ×”×¦×œ×—×•×ª ×•×œ×¨×•×•×ª × ×—×ª ×ž×›×œ ×”×ž×©×¤×—×”, ×•×”×›×™ ×—×©×•×‘ ×©×ª×–×›×” ×œ×—×™×•×ª ×‘×¨×•×’×¢ ×•×‘×›×™×£, ×›×™ ×‘××ž×ª ×›×‘×¨ ×”×’×™×¢ ×”×’×™×œ ×œ×”×ª×—×™×œ ×œ×”× ×•×ª ×ž×›×œ ×ž×” ×©×‘× ×™×ª.\n\n×‘××”×‘×” ×’×“×•×œ×”, ××‘×™×‘`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "× ×•×¢×",
    photo: "assets/people/noam.jpg",
    text: `×—×’ ×”××™×œ× ×•×ª ×”×’×™×¢ ×•×œ× ×• ×”×•× ×¨×§ ×ž×¡×ž×œ ×“×‘×¨ ××—×“, ×©×™×•× ×”×•×œ×“×ª×š ×›××Ÿ.\n×¢×“×™×™×Ÿ ××•×ª×™ ××™×œ×Ÿ ×¦×¢×™×¨ ×©×œ× ×§×©×” ×œ×• ×©×•× ×“×‘×¨.\n×ž×•×§×“× ×‘×‘×•×§×¨ ×”×•× ×›×‘×¨ ×§× ×œ×‘×©×œ ×•×œ×ª×§×ª×§ ×•××—×¨×™ ×–×” ×™×©×¨ ×œ×’×œ×¨×™×” ×‘×¦×¢×“×™ ×¢× ×§.\n×”×›×œ ×¢×•×©×” ×ž×”×œ×‘ ×•×”× ×©×ž×” ×•×ª×ž×™×“ ×›××Ÿ ×œ×ª×ª ×¢×–×¨×”.\n×ž××—×œ ×œ×š ×©× ×” ×©×œ ×‘×¨×™××•×ª, ××•×©×¨, ×¦×—×•×§, ××”×‘×”, ×¢×•×©×¨, ×‘×¨×›×” ×•×¡×™×¤×•×§.\n××ž×Ÿ ×•×”×—×œ×•×ž×•×ª ×©×œ×š ×™×ª×’×©×ž×• ×‘×ž×œ×•××.\n×× ×™ ×ž××—×œ ×œ×š ×©×ª×ž×©×™×š ×œ×”× ×•×ª ×•×œ×˜×™×™×œ ×‘×¢×•×œ×, ×œ×”×™×•×ª ×‘×¢×œ × ××ž×Ÿ ×•××‘× ×ž×•×©×œ×, ××™×© ×¢×¡×§×™× ×œ× ×§×˜×Ÿ.\n×× ×™ ×›××Ÿ ×‘×©×‘×™×œ×š ×œ×›×œ ×‘×¢×™×” ×˜×›× ×•×œ×•×’×™×ª ×›×ž×•×‘×Ÿ,\n×•×œ× ×©×›×—×ª×™ ××ª ×”×˜× ×™×¡ ×‘×©×‘×ª×•×ª ×‘×‘×•×§×¨, ××‘×œ ×‘×•× × ×•×“×”, ××•×œ×™ ×™×•× ××—×“ ×¢×•×“ ×ª×¢×§×•×£ ××•×ª×™.. ××• ×œ×¤×—×•×ª ×ª× ×¡×”.\n×ž×–×œ ×˜×•×‘ ×¢× ×§,\n× ×•×¢×.`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "×“×•×œ×‘",
    photo: "assets/people/dolev.jpg",
    text: `×™×© ×× ×©×™× ×©×”×’×™×œ ×©×œ×”× ×”×•× ×¨×§ ×ž×¡×¤×¨ ×•××ª×” ×”×”×•×›×—×” ×”×›×™ ×˜×•×‘×” ×œ×–×”.\n×‘×Ÿ 54 ×¢× ×× ×¨×’×™×•×ª ×—×™×•×‘×™×•×ª ×•×¨×•×— ×¦×¢×™×¨×”.\n×ž××—×œ×ª ×œ×š ×œ×”×ž×©×™×š ×œ×”× ×•×ª ×ž×”×—×™×™×, ×œ×”×’×©×™× ×ž×˜×¨×•×ª, ×œ×¦×‘×•×¨ ×—×•×•×™×•×ª ×•×œ×”×ª×ž×œ× ×‘×¡×™×¤×•×§ ×•×©×ž×—×”.\n×©×ª×ž×©×™×š ×œ×¦×¢×•×“ ×œ×¦×™×“×” ×©×œ ××•×¨×”, ×©×•×ª×¤×ª×š ×œ×—×™×™× ×•×œ×“×¨×š, ×‘×©×•×ª×¤×•×ª ××ž×™×ª×™×ª, ×‘×¢×©×™×™×” ×ž×©×•×ª×¤×ª, ×‘×ª×ž×™×›×” ×”×“×“×™×ª ×•×‘×”×¨×‘×” ×¨×’×¢×™× ×©×œ ××•×©×¨ ×™×—×“.\n×ª×•×“×” ×¢×œ ×”× ×ª×™× ×” ×”××™× ×¡×•×¤×™×ª, ×¢×œ ×”×—×¨×™×¦×•×ª ×•×”×ž×¡×™×¨×•×ª, ×¢×œ ×›×š ×©××ª×” ×ª×ž×™×“ ×¢×•×©×” ×”×›×œ ×‘××”×‘×” ×•×‘×—×™×•×š ×•××£ ×¤×¢× ×œ× × ×•×ª×Ÿ ×ª×—×•×©×” ×©×§×©×” ××• ×©××™×Ÿ ×›×—.\n×•×›×ž×•×‘×Ÿ, ××™ ××¤×©×¨ ×©×œ× ×œ×”×–×›×™×¨ ××ª ×”××•×›×œ ×”× ×”×“×¨ ×•×”×§×¦×™×¦×•×ª ×“×’×™× ×”×˜×¢×™×ž×•×ª ×©×”×¤×›×• ×œ×“×™×‘×•×¨ ×”×—× ×‘×©×•×œ×—×Ÿ.\n×ž××—×œ×ª ×œ×š ×‘×¨×™××•×ª ××™×ª× ×”, ×”×¦×œ×—×” ×‘×›×œ ×ª×—×•×, ×©×œ×•×•×”, ×©×ž×—×” ×•×”×ž×•×Ÿ ×©× ×™× ×˜×•×‘×•×ª ×•×ž×‘×•×¨×›×•×ª.\n×ž×–×œ ×˜×•×‘ ×•×”×¨×‘×” ××•×©×¨,\n×“×•×œ×‘.`
  },
  {
    title: "×œ××™×œ×Ÿ ×”×™×§×¨",
    from: "×ž×¢×™×™×Ÿ",
    photo: "assets/people/mayaan.jpg",
    text: `×”× ×” ×”×’×™×¢×” ×¢×•×“ ×©× ×”\n×©×‘×” ×× ×—× ×• ×—×•×’×’×™× ×œ×š\n×•×–×” ×”×–×ž×Ÿ ×œ×”×•×“×•×ª ×•×œ×”×’×™×“ ×ª×•×“×”,\n×¢×œ ×”×“×’×™× ×•×¢×œ ×”×§×¦×™×¦×•×ª ×‘×¨×•×˜×‘ ×œ×™×ž×•×Ÿ,\n×¢×œ ×–×” ×©××ª×” ×—×•×©×‘ ×©××ª×” ×ž×œ×š ×”×˜× ×™×¡,\n×¢×œ ×”×¤×™× ×•×§×™× ×œ×©×‘×ª ×©××ª×” ×•××ž× ×ž×›×™× ×™× ×œ× ×•.\n×× ×™ ×ž××—×œ×ª ×œ×š ×œ×”×™×•×ª ×‘×¨×™× ×‘×œ×™ ×¦×•×•××¨ ×ª×¤×•×¡,\n×ž×œ× × ×™×¦×—×•× ×•×ª ×‘×˜× ×™×¡,\n×œ×”×ž×©×™×š ×œ×˜×™×™×œ ×‘×¢×•×œ× ×•×œ×”×’×™×“ ×©××ª×” ××™×˜×œ×§×™,\n×œ×”× ×•×ª ×ž×”×™×œ×“×™×,\n×œ×”× ×•×ª ×ž×”×§× ×™×•×ª ×‘×©×•×§ ×¢× ×”×§×•×¨×§×™× ×˜ ×”×—×“×© ×©×œ×š.\n×•×”×›×™ ×—×©×•×‘ â€“ ×ª×ž×©×™×š ×œ×”×™×•×ª ×‘×“×™×•×§ ×›×›×”, ×¦×¢×™×¨ ×‘× ×¤×© ×•×¢× ×”×× ×¨×’×™×•×ª.\n×ž××—×œ×ª ×œ×š ×©× ×” ×ž×œ××” ×‘×˜×™×•×œ×™×, ×•× ×™×¦×—×•× ×•×ª (×‘×˜× ×™×¡ ).`
  }
];

let currentIndex = 0;
let isTransitioning = false;

// DOM Elements
const card = document.querySelector(".card");
const titleEl = document.querySelector("[data-title]");
const signatureEl = document.querySelector("[data-signature]");
const signatureNameEl = document.querySelector("[data-signature-name]");
const signaturePhotoEl = document.querySelector("[data-signature-photo]");
const progressEl = document.getElementById("blessing-progress");
const linesEl = document.getElementById("blessing-lines");
const nextBtn = document.getElementById("next");
const prevBtn = document.getElementById("prev");
const celebrateBtn = document.getElementById("celebrate");
const musicToggle = document.getElementById("music-toggle");
const musicNext = document.getElementById("music-next");
const bgMusic = document.getElementById("bg-music");
const musicLabel = document.getElementById("music-label");
const dotsEl = document.getElementById("blessing-dots");
const canvas = document.getElementById("confetti-canvas");
const ctx = canvas.getContext("2d");

// Confetti System
let particles = [];
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

class Particle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = canvas.height + 10;
    this.size = Math.random() * 8 + 4;
    this.speedY = Math.random() * -15 - 10;
    this.speedX = Math.random() * 6 - 3;
    this.gravity = 0.4;
    this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
    this.rotation = Math.random() * 360;
    this.rotationSpeed = Math.random() * 10 - 5;
    this.opacity = 1;
  }
  update() {
    this.speedY += this.gravity;
    this.y += this.speedY;
    this.x += this.speedX;
    this.rotation += this.rotationSpeed;
    if (this.speedY > 0) this.opacity -= 0.01;
  }
  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate((this.rotation * Math.PI) / 180);
    ctx.globalAlpha = this.opacity;
    ctx.fillStyle = this.color;
    ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
    ctx.restore();
  }
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles = particles.filter((p) => p.opacity > 0);
  particles.forEach((p) => {
    p.update();
    p.draw();
  });
  if (particles.length > 0) requestAnimationFrame(animateParticles);
}

function burst() {
  for (let i = 0; i < 150; i++) {
    particles.push(new Particle());
  }
  animateParticles();
}

// Card Tilt
function handleTilt(e) {
  if (window.innerWidth < 768) return;
  const rect = card.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const centerX = rect.width / 2;
  const centerY = rect.height / 2;
  const rotateX = (centerY - y) / 20;
  const rotateY = (x - centerX) / 20;
  card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
}

function resetTilt() {
  card.style.transform = "rotateX(0) rotateY(0)";
}

card.addEventListener("mousemove", handleTilt);
card.addEventListener("mouseleave", resetTilt);

// Content Management
function renderBlessing(index, direction = "next") {
  if (isTransitioning) return;
  isTransitioning = true;

  const blessing = blessings[index];
  
  // Animation Phase 1: Out
  linesEl.style.transition = "opacity 0.4s ease, transform 0.4s ease";
  linesEl.style.opacity = "0";
  linesEl.style.transform = direction === "next" ? "translateX(-20px)" : "translateX(20px)";

  setTimeout(() => {
    // Update Content
    titleEl.textContent = blessing.title;
    signatureNameEl.textContent = blessing.from;
    signaturePhotoEl.src = blessing.photo;
    progressEl.textContent = `×‘×¨×›×” ${index + 1} ×ž×ª×•×š ${blessings.length}`;
    
    linesEl.innerHTML = blessing.text
      .split("\n")
      .map((line, i) => {
        const trimmed = line.trim();
        return `<span class="line ${trimmed === "" ? "spacer" : ""}" style="--i: ${i}">${trimmed || "&nbsp;" }</span>`;
      })
      .join("");

    updateDots(index);
    updateButtons(index);

    // Animation Phase 2: In
    linesEl.style.transform = direction === "next" ? "translateX(20px)" : "translateX(-20px)";
    requestAnimationFrame(() => {
      linesEl.style.opacity = "1";
      linesEl.style.transform = "translateX(0)";
      setTimeout(() => {
        isTransitioning = false;
      }, 400);
    });
  }, 400);
}

function updateDots(index) {
  dotsEl.innerHTML = blessings
    .map((_, i) => `<button class="dot ${i === index ? "is-active" : ""}" aria-label="×‘×¨×›×” ${i + 1}"></button>`)
    .join("");
  dotsEl.querySelectorAll(".dot").forEach((dot, i) => {
    dot.onclick = () => {
      if (i !== currentIndex) {
        const dir = i > currentIndex ? "next" : "prev";
        currentIndex = i;
        renderBlessing(currentIndex, dir);
      }
    };
  });
}

function updateButtons(index) {
  prevBtn.disabled = index === 0;
  nextBtn.disabled = index === blessings.length - 1;
}

// Navigation
nextBtn.onclick = () => {
  if (currentIndex < blessings.length - 1) {
    currentIndex++;
    renderBlessing(currentIndex, "next");
  }
};

prevBtn.onclick = () => {
  if (currentIndex > 0) {
    currentIndex--;
    renderBlessing(currentIndex, "prev");
  }
};

celebrateBtn.onclick = burst;

// Music (Simplified for wow)
const tracks = [
  { name: "Sunny Day", url: "https://cdn.pixabay.com/download/audio/2023/03/25/audio_c3aa6a5b4b.mp3?filename=sunny-day-14569.mp3" },
  { name: "Happy Background", url: "https://cdn.pixabay.com/download/audio/2023/04/04/audio_234d61636d.mp3?filename=happy-background-113996.mp3" }
];
let currentTrack = 0;

function updateMusicUI() {
  musicLabel.textContent = tracks[currentTrack].name;
  musicToggle.classList.toggle("is-playing", !bgMusic.paused);
  musicToggle.textContent = bgMusic.paused ? "× ×’×Ÿ ×ž×•×–×™×§×”" : "×›×‘×” ×ž×•×–×™×§×”";
}

musicToggle.onclick = () => {
  if (bgMusic.paused) {
    if (!bgMusic.src) bgMusic.src = tracks[currentTrack].url;
    bgMusic.play().catch(() => alert("× × ×œ×œ×—×•×¥ ×©×•×‘ ×œ×”×¤×¢×œ×ª ×ž×•×–×™×§×”"));
  } else {
    bgMusic.pause();
  }
  updateMusicUI();
};

musicNext.onclick = () => {
  currentTrack = (currentTrack + 1) % tracks.length;
  bgMusic.src = tracks[currentTrack].url;
  bgMusic.play();
  updateMusicUI();
};

// Touch Gestures
let touchStartX = 0;
card.addEventListener("touchstart", (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
card.addEventListener("touchend", (e) => {
  const touchEndX = e.changedTouches[0].clientX;
  if (touchStartX - touchEndX > 50) nextBtn.click();
  if (touchEndX - touchStartX > 50) prevBtn.click();
}, { passive: true });

// Init
renderBlessing(0);
updateMusicUI();
